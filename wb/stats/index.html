<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War Brokers Stats and Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        :root {
            --background-color: #f8f9fa;
            --text-color: #333;
            --header-bg: #ffffff;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --card-shadow-hover: 0 6px 12px rgba(0,0,0,0.15);
            --border-color: #e0e0e0;
            --input-border: #ced4da;
            --input-shadow: rgba(0, 123, 255, 0.25);
            --suggestion-bg: #ffffff;
            --suggestion-hover: #e9ecef;
            --chart-title: #495057;
            --chart-bg: rgba(108, 117, 125, 0.6);
            --chart-border: rgba(108, 117, 125, 1);
            --chart-hover: rgba(73, 80, 87, 0.8);
            --feature-name: #1c2526;
            --dock-bg: #ffffff;
        }
        [data-theme="dark"] {
            --background-color: #1a1a1a;
            --text-color: #e0e0e0;
            --header-bg: #2c2c2c;
            --card-bg: #2c2c2c;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.3);
            --card-shadow-hover: 0 6px 12px rgba(0,0,0,0.4);
            --border-color: #3c3c3c;
            --input-border: #4a4a4a;
            --input-shadow: rgba(0, 123, 255, 0.4);
            --suggestion-bg: #2c2c2c;
            --suggestion-hover: #3c3c3c;
            --chart-title: #b0b0b0;
            --chart-bg: rgba(108, 117, 125, 0.7);
            --chart-border: rgba(108, 117, 125, 1);
            --chart-hover: rgba(150, 150, 150, 0.8);
            --feature-name: #d0d0d0;
            --dock-bg: #2c2c2c;
        }
        header { 
            background-color: var(--header-bg); 
            border-bottom: 1px solid var(--border-color); 
            position: relative;
        }
        input { 
            border-radius: 8px; 
            border: 1px solid var(--input-border); 
            padding: 12px; 
            font-size: 16px; 
            transition: box-shadow 0.2s; 
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        input:focus { 
            box-shadow: 0 0 0 0.2rem var(--input-shadow); 
            outline: none; 
        }
        .suggestion-item { 
            transition: background-color 0.2s; 
            background-color: var(--suggestion-bg);
        }
        .suggestion-item:hover { 
            background-color: var(--suggestion-hover); 
        }
        .player-name { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: var(--card-shadow); 
            margin: 20px 0;
        }
        .stat-bubble { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            padding: 15px; 
            box-shadow: var(--card-shadow); 
            text-align: center; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            width: 140px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .stat-bubble:hover { 
            transform: translateY(-5px) scale(1.02); 
            box-shadow: var(--card-shadow-hover);
        }
        .chart-container { 
            margin-bottom: 40px; 
        }
        .chart-container h2 { 
            color: var(--chart-title); 
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .dock-container {
            padding-bottom: 20px;
            background-color: var(--dock-bg);
            border-top: 1px solid var(--border-color);
        }
        .toggle-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, transform 0.2s;
        }
        .toggle-button:hover {
            background-color: var(--suggestion-hover);
            transform: scale(1.1);
        }
        .toggle-button i {
            font-size: 20px;
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const WeaponName = {
            "p09": "Air Strike",
            "p11": "BGM",
            "p52": "Tank Lvl-1",
            "p53": "APC Lvl-1",
            "p54": "Heli Lvl-1",
            "p55": "Tank Lvl-2",
            "p56": "APC Lvl-2",
            "p57": "Heli Lvl-2",
            "p58": "Tank Lvl-3",
            "p59": "APC Lvl-3",
            "p60": "Heli Lvl-3",
            "p61": "AR Rifle",
            "p62": "AK Rifle",
            "p63": "Pistol",
            "p64": "Hunting Rifle",
            "p65": "RPG",
            "p66": "Shotgun",
            "p67": "Sniper Rifle",
            "p68": "Sub Machine Gun",
            "p69": "Homing Missile",
            "p71": "Grenade",
            "p74": "Heli Minigun",
            "p75": "Tank Minigun",
            "p76": "Knife",
            "p78": "Revolver",
            "p79": "Minigun",
            "p80": "Grenade Launcher",
            "p81": "Smoke Grenade",
            "p82": "Jet (1 Fin) Rockets",
            "p83": "Jet (1 Fin) Homing",
            "p84": "Jet (1 Fin) Machine Gun",
            "p85": "Jet (2 Fin) Rockets",
            "p86": "Jet (2 Fin) Homing",
            "p87": "Jet (2 Fin) Machine Gun",
            "p88": "Fists",
            "p89": "VSS",
            "p90": ".50 Cal Sniper",
            "p91": "MG Turret",
            "p92": "Crossbow",
            "p93": "SCAR",
            "p94": "Tactical Shotgun",
            "p95": "VEK SMG",
            "p96": "Desert",
            "p97": "Auto Pistol",
            "p98": "LMG",
            "p99": "KBAR",
            "p100": "Mace",
            "p101": "Rubber Chicken",
            "p102": "Butterfly",
            "p103": "Chainsaw",
            "p104": "AK SMG",
            "p105": "Auto Sniper",
            "p106": "Unreleased AR",
            "p107": "Sawed Off",
            "p108": "Healing Pistol",
            "p109": "MP7",
            "p110": "Implosion Grenade",
            "p111": "Laser Trip Mine",
            "p112": "Concussion Grenade",
            "p126": "G3A3",
            "p128": "Marksman's Rifle",
            "p129": "Mutant",
        };

        const gameModeName = {
            "m00": "Team Death Match",
            "m01": "Demolition Derby",
            "m02": "Protect Leader",
            "m03": "Resource Capture",
            "m04": "Race",
            "m05": "Tank Battle",
            "m06": "Tank King",
            "m07": "Capture Point",
            "m08": "Vehicle Escort",
            "m09": "Package Drop",
            "m10": "Missile Launch/Bomb Disposal",
            "m11": "Battle Royale",
            "m12": "Competitive",
            "m13": "Competitive (Lobby)",
            "m14": "Battle Royale (Lobby)",
            "m15": "Gun Game",
        };

        const VehicleName = {
            "v00": "Tank Lvl-1",
            "v01": "Tank Lvl-2",
            "v02": "Tank Lvl-3",
            "v10": "APC Lvl-1",
            "v11": "APC Lvl-2",
            "v12": "APC Lvl-3",
            "v13": "Car",
            "v14": "Unknown Vehicle 14",
            "v15": "1 Fin Jet Machine Gun",
            "v16": "Unknown Vehicle 16",
            "v17": "Unknown Vehicle 17",
            "v18": "Unknown Vehicle 18",
            "v19": "Unknown Vehicle 19",
            "v20": "Heli Lvl-1",
            "v21": "Heli Lvl-2",
            "v22": "Heli Lvl-3",
            "v23": "Heli (No Weapon)",
            "v30": "Person",
            "v40": "Jet (1 Fin)",
            "v41": "Jet (2 Fin)",
            "v50": "Machine Gun Turret",
            "v60": "Unknown Vehicle 60",
            "v110": "Unknown Vehicle 110",
            "v111": "Unknown Vehicle 111",
            "v112": "Unknown Vehicle 112",
            "v113": "Unknown Vehicle 113",
        };

        const BarChart = ({ title, data, parentKey }) => {
            const canvasRef = useRef(null);

            const getLabel = (key) => {
                let map;
                if (['wins', 'losses'].includes(parentKey)) {
                    map = gameModeName;
                } else if (['self_destructs', 'distance_driven', 'distance_driven_count', 'kills_per_vehicle'].includes(parentKey)) {
                    map = VehicleName;
                } else {
                    map = WeaponName;
                }
                return map[key] || key;
            };

            useEffect(() => {
                const sortedKeys = Object.keys(data).sort((a, b) => data[b] - data[a]);
                const sortedData = sortedKeys.map(key => data[key]);
                const maxLabelLength = Math.max(...sortedKeys.map(key => getLabel(key).length));
                const maxValueLength = Math.max(...sortedData.map(val => Math.ceil(val).toString().length));
                const labelsWithValues = sortedKeys.map(key => {
                    const label = getLabel(key);
                    const value = Math.ceil(data[key]).toString();
                    const paddedLabel = label.padEnd(maxLabelLength, ' ');
                    const paddedValue = value.padStart(maxValueLength, ' ');
                    return `${paddedLabel} ${paddedValue}`;
                });
                const ctx = canvasRef.current.getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labelsWithValues,
                        datasets: [{
                            label: title,
                            data: sortedData,
                            backgroundColor: 'rgba(108, 117, 125, 0.6)',
                            borderColor: 'rgba(108, 117, 125, 1)',
                            borderWidth: 1,
                            hoverBackgroundColor: 'rgba(73, 80, 87, 0.8)'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: {
                            x: { beginAtZero: true },
                            y: {
                                ticks: {
                                    font: {
                                        size: 16,
                                        family: 'monospace'
                                    },
                                    align: 'end',
                                    callback: function(value, index) {
                                        return labelsWithValues[index];
                                    }
                                }
                            }
                        },
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                animation: {
                                    duration: 100
                                }
                            }
                        }
                    }
                });
            }, [data, title, parentKey]);

            return <canvas ref={canvasRef} style={{ height: '800px', width: '100%' }} />;
        };

        const StatsGrid = ({ children }) => {
            const gridRef = useRef(null);

            useEffect(() => {
                if (gridRef.current) {
                    gsap.from(gridRef.current.children, {
                        opacity: 0,
                        duration: 0.5,
                        ease: 'power2.out'
                    });
                }
            }, []);

            return (
                <div ref={gridRef} className="stats-grid">
                    {children}
                </div>
            );
        };

        const DockComponent = ({ onUserClick, onSquadClick }) => {
            const dockRef = useRef(null);
            const itemRefs = useRef([]);
            const items = [
                { label: 'user', icon: 'user', onClick: onUserClick },
                { label: 'squad', icon: 'people-roof', onClick: onSquadClick },
            ];

            useEffect(() => {
                itemRefs.current = itemRefs.current.slice(0, items.length);
                gsap.from(itemRefs.current, {
                    y: 50,
                    opacity: 0,
                    scale: 0.8,
                    stagger: 0.2,
                    duration: 0.6,
                    ease: 'back.out(1.7)',
                });
            }, []);

            const itemSize = 40;
            const magnifiedSize = 50;
            const maxScale = magnifiedSize / itemSize;
            const range = 100;

            const handleMouseMove = (e) => {
                const dockRect = dockRef.current.getBoundingClientRect();
                const mouseX = e.clientX - dockRect.left;
                itemRefs.current.forEach((itemRef, index) => {
                    if (itemRef) {
                        const itemRect = itemRef.getBoundingClientRect();
                        const centerX = itemRect.left - dockRect.left + itemRect.width / 2;
                        const distance = Math.abs(mouseX - centerX);
                        let scale = 1;
                        if (distance < range) {
                            scale = 1 + (maxScale - 1) * (1 - distance / range);
                        }
                        itemRef.style.transform = `scale(${scale})`;
                        itemRef.style.transition = 'transform 0.1s';
                    }
                });
            };

            const handleMouseLeave = () => {
                itemRefs.current.forEach((itemRef) => {
                    if (itemRef) {
                        itemRef.style.transform = 'scale(1)';
                    }
                });
            };

            return (
                <div
                    ref={dockRef}
                    onMouseMove={handleMouseMove}
                    onMouseLeave={handleMouseLeave}
                    className="dock-container"
                    style={{
                        position: 'fixed',
                        bottom: 0,
                        left: 0,
                        right: 0,
                        height: '82px',
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'flex-end',
                    }}
                >
                    <div style={{ display: 'flex', alignItems: 'flex-end' }}>
                        {items.map((item, index) => (
                            <div
                                ref={(el) => (itemRefs.current[index] = el)}
                                key={index}
                                onClick={item.onClick}
                                style={{
                                    width: `${itemSize}px`,
                                    height: `${itemSize}px`,
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    cursor: 'pointer',
                                    transformOrigin: 'bottom',
                                    margin: '0 10px',
                                }}
                            >
                                <i className={`fas fa-${item.icon}`} style={{ fontSize: '24px', color: 'var(--text-color)' }}></i>
                                <span style={{ fontSize: '12px', color: 'var(--text-color)' }}>{item.label}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = useState('user');
            const [searchQuery, setSearchQuery] = useState('');
            const [suggestions, setSuggestions] = useState([]);
            const [player, setPlayer] = useState(null);
            const [theme, setTheme] = useState('light');
            const debounceRef = useRef(null);
            const nameRef = useRef(null);

            const toggleTheme = () => {
                const newTheme = theme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                document.body.setAttribute('data-theme', newTheme);
            };

            const fetchPlayer = async (uid) => {
                try {
                    const res = await fetch(`https://wbapi.wbpjs.com/players/getPlayer?uid=${uid}`);
                    const data = await res.json();
                    setPlayer(data);
                    window.history.pushState({}, '', `/wb/stats/${uid}`);
                } catch (e) {
                    console.log('Fetch player failed', e);
                }
            };

            const fetchSuggestions = async (query) => {
                if (query === '') {
                    setSuggestions([]);
                    return;
                }
                let results = [];
                try {
                    const res = await fetch(`https://wbapi.wbpjs.com/players/searchByName?query=${query}`);
                    results = await res.json();
                } catch (e) {
                    console.log('Endpoint failed', e);
                }
                const unique = results;
                console.log('Results:', unique);
                setSuggestions(unique);
            };

            const handleChange = (e) => {
                const q = e.target.value;
                setSearchQuery(q);
                if (debounceRef.current) clearTimeout(debounceRef.current);
                debounceRef.current = setTimeout(() => fetchSuggestions(q), 100);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    if (debounceRef.current) clearTimeout(debounceRef.current);
                    fetchSuggestions(searchQuery);
                }
            };

            const handleSelect = async (uid) => {
                setSuggestions([]);
                setSearchQuery('');
                await fetchPlayer(uid);
            };

            useEffect(() => {
                const path = window.location.pathname;
                const match = path.match(/^\/wb\/stats\/(.+)/);
                if (match) {
                    const uid = match[1];
                    fetchPlayer(uid);
                }
            }, []);

            useEffect(() => {
                if (player && nameRef.current) {
                    gsap.from(nameRef.current, { 
                        opacity: 0, 
                        duration: 0.5, 
                        ease: 'power2.out' 
                    });
                }
            }, [player]);

            return (
                <div style={{ display: 'flex', flexDirection: 'column', height: '100vh' }}>
                    <header style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '80px' }}>
                        <img
                            src="https://stats.warbrokers.io/images/War_Brokers_Logo_med_ORIG.png"
                            alt="Logo"
                            style={{ height: '60px' }}
                        />
                        <h1 style={{ marginLeft: '10px', color: 'var(--text-color)' }}>War Brokers Stats and Analytics</h1>
                        <button className="toggle-button" onClick={toggleTheme}>
                            <i className={`fas fa-${theme === 'light' ? 'moon' : 'sun'}`}></i>
                        </button>
                    </header>
                    <main style={{ flex: 1, overflow: 'auto', padding: '20px', backgroundColor: 'var(--background-color)' }}>
                        {page === 'user' && (
                            <div>
                                <div style={{ position: 'relative', maxWidth: '400px', margin: '0 auto' }}>
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={handleChange}
                                        onKeyDown={handleKeyDown}
                                        placeholder="Search player..."
                                        style={{ width: '100%', boxSizing: 'border-box' }}
                                    />
                                    {suggestions.length > 0 && (
                                        <div
                                            style={{
                                                position: 'absolute',
                                                width: '100%',
                                                maxHeight: '200px',
                                                overflow: 'auto',
                                                boxShadow: 'var(--card-shadow)',
                                                zIndex: 1,
                                                borderRadius: '8px',
                                                marginTop: '4px'
                                            }}
                                        >
                                            {suggestions.map((item, idx) => (
                                                <div
                                                    key={idx}
                                                    className="suggestion-item"
                                                    onClick={() => handleSelect(item.uid)}
                                                    style={{ padding: '12px', cursor: 'pointer' }}
                                                >
                                                    <div style={{ fontSize: '18px', color: 'var(--text-color)' }}>{item.nick}</div>
                                                    <div style={{ fontSize: '14px', color: theme === 'light' ? '#6c757d' : '#9ca3af' }}>{item.uid}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                {player && (
                                    <div>
                                        <div ref={nameRef} className="player-name" style={{ textAlign: 'center' }}>
                                            <div style={{ fontSize: '28px', fontWeight: 'bold', color: 'var(--text-color)' }}>
                                                [{player.squad}] {player.nick}
                                            </div>
                                            <div style={{ fontSize: '16px', color: theme === 'light' ? '#6c757d' : '#9ca3af' }}>{player.uid}</div>
                                        </div>
                                        <StatsGrid>
                                            {[
                                                'level',
                                                'xp',
                                                'coins',
                                                'killsELO',
                                                'gamesELO',
                                                'number_of_jumps',
                                                'scuds_launched',
                                                'zombie_kills',
                                                'zombie_deaths',
                                                'zombie_wins',
                                            ].map((key) => (
                                                <div key={key} className="stat-bubble">
                                                    <div style={{ fontSize: '20px', fontWeight: 'bold', color: 'var(--text-color)' }}>{player[key]}</div>
                                                    <div style={{ fontSize: '12px', color: 'var(--feature-name)', textTransform: 'capitalize' }}>{key.replace(/_/g, ' ')}</div>
                                                </div>
                                            ))}
                                        </StatsGrid>
                                        <div style={{ marginTop: '40px' }}>
                                            {Object.keys(player)
                                                .filter((key) => typeof player[key] === 'object' && player[key] !== null && !Array.isArray(player[key]))
                                                .map((parentKey) => (
                                                    <div key={parentKey} className="chart-container">
                                                        <h2>{parentKey.replace(/_/g, ' ').toUpperCase()}</h2>
                                                        <BarChart title={parentKey} data={player[parentKey]} parentKey={parentKey} />
                                                    </div>
                                                ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {page === 'squad' && (
                            <div>
                                <p style={{ textAlign: 'center', color: theme === 'light' ? '#6c757d' : '#9ca3af' }}>Squad stats coming soon.</p>
                            </div>
                        )}
                    </main>
                    <DockComponent onUserClick={() => setPage('user')} onSquadClick={() => setPage('squad')} />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
